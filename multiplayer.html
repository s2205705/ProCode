<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer — Python Pathfinder</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="cute_mode.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
</head>
<body class="cute-theme">
    <nav class="navbar cute">
        <a href="dashboard.html" class="logo cute"><i class="fas fa-code"></i> Python Pathfinder</a>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link cute">Dashboard</a>
            <a href="game.html" class="nav-link cute">Play</a>
            <a href="multiplayer.html" class="nav-link cute active">Multiplayer</a>
            <a href="leaderboard.html" class="nav-link cute">Leaderboard</a>
            <button id="themeToggle" class="btn cute small">Switch to Deadly Mode</button>
        </div>
    </nav>

<main>
<div class="multiplayer-container cute">
    <!-- Header Section -->
    <div class="multiplayer-header cute">
        <h1><i class="fas fa-crosshairs"></i> Multiplayer Arena</h1>
        <p class="subtitle cute">Challenge other players in real-time coding battles</p>
        
        <div class="connection-status cute">
            <div class="status-indicator connected" id="statusIndicator">
                <i class="fas fa-wifi"></i>
                <span id="connectionStatus">Connecting...</span>
            </div>
            <div class="online-count cute">
                <i class="fas fa-users"></i>
                <span id="onlineCount">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="multiplayer-content cute">
        <!-- Left Sidebar - Room Browser -->
        <div class="room-browser cute">
            <div class="browser-header cute">
                <h2><i class="fas fa-door-open"></i> Available Rooms</h2>
                <div class="browser-controls">
                    <button class="btn cute small" id="refreshRooms">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn cute small" id="createRoomBtn">
                        <i class="fas fa-plus"></i> Create Room
                    </button>
                </div>
            </div>

            <!-- Room Creation Form -->
            <div class="room-creation cute" id="roomCreationForm" style="display: none;">
                <h3><i class="fas fa-edit"></i> Create New Room</h3>
                <div class="form-group cute">
                    <label for="roomName"><i class="fas fa-heading"></i> Room Name</label>
                    <input type="text" id="roomName" placeholder="Enter room name" class="cute">
                </div>
                <div class="form-group cute">
                    <label for="challengeSelect"><i class="fas fa-tasks"></i> Challenge</label>
                    <select id="challengeSelect" class="cute">
                        <option value="random">Random Challenge</option>
                        <option value="1">Python Basics (Beginner)</option>
                        <option value="2">Functions & Loops (Intermediate)</option>
                        <option value="3">Data Structures (Advanced)</option>
                    </select>
                </div>
                <div class="form-group cute">
                    <label for="timeLimit"><i class="fas fa-clock"></i> Time Limit</label>
                    <select id="timeLimit" class="cute">
                        <option value="180">3 minutes</option>
                        <option value="300">5 minutes</option>
                        <option value="600">10 minutes</option>
                    </select>
                </div>
                <div class="form-group cute">
                    <label class="checkbox-label cute">
                        <input type="checkbox" id="privateRoom">
                        <span class="checkmark"></span>
                        Private Room (Invite Only)
                    </label>
                </div>
                <div class="form-actions">
                    <button class="btn cute" id="confirmCreateRoom">
                        <i class="fas fa-check"></i> Create Room
                    </button>
                    <button class="btn cute outline" id="cancelCreateRoom">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <!-- Quick Match -->
            <div class="quick-match cute">
                <h3><i class="fas fa-bolt"></i> Quick Match</h3>
                <p>Find an opponent instantly with similar skill level</p>
                <button class="btn cute large" id="quickMatchBtn">
                    <i class="fas fa-search"></i> Find Match
                </button>
                <div class="matchmaking-status" id="matchmakingStatus" style="display: none;">
                    <div class="searching-animation">
                        <div class="pulse-dot"></div>
                        <span>Searching for opponent...</span>
                    </div>
                    <button class="btn cute small cancel" id="cancelMatchmaking">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Room List -->
            <div class="room-list cute">
                <h3><i class="fas fa-list"></i> Active Rooms</h3>
                <div class="room-filters cute">
                    <button class="filter-btn cute active" data-filter="all">All</button>
                    <button class="filter-btn cute" data-filter="beginner">Beginner</button>
                    <button class="filter-btn cute" data-filter="intermediate">Intermediate</button>
                    <button class="filter-btn cute" data-filter="advanced">Advanced</button>
                    <button class="filter-btn cute" data-filter="empty">Empty</button>
                </div>
                
                <div class="rooms-container" id="roomsContainer">
                    <!-- JS will populate rooms here -->
                </div>
            </div>
        </div>

        <!-- Main Arena -->
        <div class="battle-arena cute">
            <!-- Waiting Lobby -->
            <div class="waiting-lobby cute" id="waitingLobby" style="display: none;">
                <div class="lobby-content">
                    <div class="lobby-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h2>Waiting for Opponent</h2>
                    <p>Share this room code with friends or wait for a random opponent</p>
                    
                    <div class="room-code cute">
                        <div class="code-display" id="roomCodeDisplay">----</div>
                        <button class="btn cute small" id="copyRoomCode">
                            <i class="fas fa-copy"></i> Copy Code
                        </button>
                    </div>
                    
                    <div class="player-list cute">
                        <div class="player you cute">
                            <div class="player-avatar cute">
                                <span class="avatar-text" id="playerAvatarInitial">P</span>
                                <div class="player-status ready"></div>
                            </div>
                            <div class="player-info">
                                <h4 id="playerName">You</h4>
                                <p class="player-rating">Rating: <span id="playerRating">1350</span></p>
                                <div class="ready-status">
                                    <button class="btn cute small ready-btn" id="readyBtn">
                                        <i class="fas fa-check"></i> Ready
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="player cute opponent">
                            <div class="player-avatar cute">
                                <i class="fas fa-user-clock"></i>
                                <div class="player-status waiting"></div>
                            </div>
                            <div class="player-info">
                                <h4 id="opponentNameDisplay">Waiting for opponent...</h4>
                                <p class="player-rating">Rating: <span id="opponentRating">---</span></p>
                                <div class="ready-status">
                                    <span class="status-text" id="opponentStatusText">Not connected</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lobby-actions">
                        <button class="btn cute secondary" id="inviteFriendBtn">
                            <i class="fas fa-user-plus"></i> Invite Friend
                        </button>
                        <button class="btn cute outline" id="leaveRoomBtn">
                            <i class="fas fa-sign-out-alt"></i> Leave Room
                        </button>
                    </div>
                </div>
            </div>

            <!-- Battle Interface -->
            <div class="battle-interface cute" id="battleInterface" style="display: none;">
                <!-- Battle Header -->
                <div class="battle-header cute">
                    <div class="battle-timer cute" id="battleTimer">
                        <i class="fas fa-clock"></i>
                        <span id="timerDisplay">05:00</span>
                    </div>
                    <div class="battle-info">
                        <h3 id="battleChallenge">Python Variables Challenge</h3>
                        <div class="challenge-meta">
                            <span class="difficulty-badge cute" id="challengeDifficulty">Beginner</span>
                            <span class="points-badge cute" id="challengePoints">100 points</span>
                        </div>
                    </div>
                    <div class="battle-scores">
                        <div class="score-player cute">
                            <span class="score-label">You</span>
                            <span class="score-value" id="playerScore">0</span>
                        </div>
                        <div class="score-vs cute">VS</div>
                        <div class="score-opponent cute">
                            <span class="score-label">Opponent</span>
                            <span class="score-value" id="opponentScore">0</span>
                        </div>
                    </div>
                </div>

                <!-- Battle Grid -->
                <div class="battle-grid cute">
                    <!-- Player Side -->
                    <div class="player-side cute">
                        <div class="player-header cute">
                            <div class="player-display cute">
                                <div class="player-avatar cute">
                                    <span class="avatar-text" id="playerInitial">P</span>
                                </div>
                                <div class="player-details">
                                    <h4 id="currentPlayerName">Player</h4>
                                    <p class="player-stats" id="playerStats">Wins: 8 • Rating: 1350</p>
                                </div>
                            </div>
                            <div class="player-status-indicator cute">
                                <div class="status ready" id="playerStatusIndicator">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Ready</span>
                                </div>
                            </div>
                        </div>

                        <div class="code-editor-section cute">
                            <div class="editor-header cute">
                                <span><i class="fas fa-code"></i> your_solution.py</span>
                                <div class="editor-actions">
                                    <button class="editor-btn" title="Format code" id="formatCodeBtn">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button class="editor-btn" title="Reset code" id="resetCodeBtn">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </div>
                            <textarea id="multiplayerCode" class="cute" spellcheck="false">
# Multiplayer Challenge
# Write your solution below

def solve_challenge():
    # Your code here
    return "Hello, World!"
                            </textarea>
                        </div>

                        <div class="player-controls cute">
                            <button class="btn cute" id="runMultiplayerBtn">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                            <button class="btn cute success" id="submitMultiplayerBtn">
                                <i class="fas fa-paper-plane"></i> Submit Solution
                            </button>
                            <button class="btn cute outline" id="requestHintBtn">
                                <i class="fas fa-lightbulb"></i> Hint (-10s)
                            </button>
                        </div>

                        <div class="player-output cute">
                            <h4><i class="fas fa-terminal"></i> Your Output</h4>
                            <pre id="playerOutput">Run your code to see output...</pre>
                        </div>
                    </div>

                    <!-- VS Divider -->
                    <div class="vs-divider cute">
                        <div class="vs-icon">
                            <i class="fas fa-crosshairs"></i>
                        </div>
                        <div class="vs-info">
                            <div class="info-item cute">
                                <i class="fas fa-code"></i>
                                <span id="playerCodeLines">0 lines</span>
                            </div>
                            <div class="info-item cute">
                                <i class="fas fa-bolt"></i>
                                <span id="playerActivity">Idle</span>
                            </div>
                            <div class="info-item cute">
                                <i class="fas fa-history"></i>
                                <span id="timeRemaining">5:00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Opponent Side -->
                    <div class="opponent-side cute">
                        <div class="player-header cute">
                            <div class="player-display cute">
                                <div class="player-avatar cute">
                                    <i class="fas fa-user-secret"></i>
                                </div>
                                <div class="player-details">
                                    <h4 id="opponentName">Opponent</h4>
                                    <p class="player-stats" id="opponentStats">Wins: --- • Rating: ---</p>
                                </div>
                            </div>
                            <div class="player-status-indicator cute">
                                <div class="status not-ready" id="opponentStatusIndicator">
                                    <i class="fas fa-clock"></i>
                                    <span>Not Ready</span>
                                </div>
                            </div>
                        </div>

                        <div class="opponent-code cute">
                            <div class="editor-header cute">
                                <span><i class="fas fa-code"></i> opponent_solution.py</span>
                                <div class="editor-status">
                                    <span id="opponentCodeStatus">Not started</span>
                                </div>
                            </div>
                            <div class="code-preview cute">
                                <div class="code-mask"></div>
                                <pre class="code-hidden">
# Opponent's code is hidden during battle
# You can see their progress indicators below
                                </pre>
                                <div class="progress-indicators" id="opponentProgressIndicators">
                                    <div class="indicator typing" style="display: none;">
                                        <div class="indicator-bar"></div>
                                        <span>Typing...</span>
                                    </div>
                                    <div class="indicator testing" style="display: none;">
                                        <div class="indicator-bar"></div>
                                        <span>Testing...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="opponent-info cute">
                            <div class="info-card cute">
                                <h5><i class="fas fa-chart-line"></i> Opponent Activity</h5>
                                <div class="activity-meter">
                                    <div class="meter-bar">
                                        <div class="meter-fill" id="opponentActivityBar" style="width: 0%"></div>
                                    </div>
                                    <span id="opponentProgress">0% complete</span>
                                </div>
                            </div>
                            <div class="info-card cute">
                                <h5><i class="fas fa-exclamation-circle"></i> Last Action</h5>
                                <p id="opponentLastAction">Waiting for opponent...</p>
                            </div>
                        </div>

                        <div class="opponent-output cute">
                            <h4><i class="fas fa-eye"></i> Opponent's Status</h4>
                            <div class="status-display" id="opponentStatusDisplay">
                                <div class="status-item">
                                    <i class="fas fa-code"></i>
                                    <span>Code length: <span id="opponentCodeLength">0</span> chars</span>
                                </div>
                                <div class="status-item">
                                    <i class="fas fa-play"></i>
                                    <span>Runs: <span id="opponentRunCount">0</span></span>
                                </div>
                                <div class="status-item">
                                    <i class="fas fa-check"></i>
                                    <span>Last test: <span id="opponentLastTest">---</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Screen -->
            <div class="results-screen cute" id="resultsScreen" style="display: none;">
                <div class="results-content cute">
                    <div class="result-header">
                        <div class="result-icon victory">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h2>Battle Results</h2>
                        <p class="result-subtitle" id="resultTitle">Victory!</p>
                    </div>

                    <div class="result-comparison cute">
                        <div class="comparison-player cute">
                            <div class="comparison-avatar cute">
                                <span class="avatar-text" id="resultPlayerInitial">P</span>
                            </div>
                            <h4 id="resultPlayerName">You</h4>
                            <div class="comparison-score">
                                <span class="score-label">Score</span>
                                <span class="score-value" id="finalPlayerScore">0</span>
                            </div>
                            <div class="comparison-stats">
                                <div class="stat cute">
                                    <span class="stat-label">Time</span>
                                    <span class="stat-value" id="playerTime">0:00</span>
                                </div>
                                <div class="stat cute">
                                    <span class="stat-label">Lines</span>
                                    <span class="stat-value" id="playerLines">0</span>
                                </div>
                                <div class="stat cute">
                                    <span class="stat-label">Runs</span>
                                    <span class="stat-value" id="playerRuns">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="comparison-vs cute">
                            <div class="vs-circle">VS</div>
                            <div class="rating-change cute">
                                <span class="change-label">Rating Change</span>
                                <span class="change-value positive" id="ratingChange">+0</span>
                            </div>
                        </div>

                        <div class="comparison-opponent cute">
                            <div class="comparison-avatar cute">
                                <i class="fas fa-user-secret"></i>
                            </div>
                            <h4 id="finalOpponentName">Opponent</h4>
                            <div class="comparison-score">
                                <span class="score-label">Score</span>
                                <span class="score-value" id="finalOpponentScore">0</span>
                            </div>
                            <div class="comparison-stats">
                                <div class="stat cute">
                                    <span class="stat-label">Time</span>
                                    <span class="stat-value" id="opponentTime">0:00</span>
                                </div>
                                <div class="stat cute">
                                    <span class="stat-label">Lines</span>
                                    <span class="stat-value" id="opponentLines">0</span>
                                </div>
                                <div class="stat cute">
                                    <span class="stat-label">Runs</span>
                                    <span class="stat-value" id="opponentRuns">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="result-details cute">
                        <div class="detail-section cute">
                            <h5><i class="fas fa-award"></i> Rewards</h5>
                            <div class="rewards-list" id="rewardsList">
                                <!-- Dynamic rewards -->
                            </div>
                        </div>
                        <div class="detail-section cute">
                            <h5><i class="fas fa-chart-bar"></i> Performance</h5>
                            <div class="performance-metrics" id="performanceMetrics">
                                <!-- Dynamic metrics -->
                            </div>
                        </div>
                    </div>

                    <div class="result-actions">
                        <button class="btn cute" id="rematchBtn">
                            <i class="fas fa-redo"></i> Rematch
                        </button>
                        <button class="btn cute secondary" id="nextOpponentBtn">
                            <i class="fas fa-user-plus"></i> New Opponent
                        </button>
                        <button class="btn cute outline" id="backToLobbyBtn">
                            <i class="fas fa-home"></i> Back to Lobby
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Chat & Info -->
        <div class="battle-sidebar cute">
            <!-- Battle Chat -->
            <div class="battle-chat cute">
                <div class="chat-header cute">
                    <h3><i class="fas fa-comments"></i> Battle Chat</h3>
                    <div class="chat-controls">
                        <button class="chat-btn" title="Toggle sounds" id="toggleSoundBtn">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button class="chat-btn" title="Clear chat" id="clearChatBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-messages cute" id="chatMessages">
                    <!-- Messages will be dynamically inserted here -->
                </div>
                <div class="chat-input cute">
                    <input type="text" id="chatInput" placeholder="Type your message..." class="cute">
                    <button class="btn cute small" id="sendMessageBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Battle Statistics -->
            <div class="battle-stats cute">
                <h3><i class="fas fa-chart-pie"></i> Live Stats</h3>
                <div class="stats-grid">
                    <div class="stat-card cute">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalBattles">0</div>
                            <div class="stat-label">Total Battles</div>
                        </div>
                    </div>
                    <div class="stat-card cute">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="winRate">0%</div>
                            <div class="stat-label">Win Rate</div>
                        </div>
                    </div>
                    <div class="stat-card cute">
                        <div class="stat-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="avgTime">0:00</div>
                            <div class="stat-label">Avg. Time</div>
                        </div>
                    </div>
                    <div class="stat-card cute">
                        <div class="stat-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalLines">0</div>
                            <div class="stat-label">Lines Written</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Tournaments -->
            <div class="tournaments cute">
                <h3><i class="fas fa-flag-checkered"></i> Active Tournaments</h3>
                <div class="tournament-list" id="tournamentList">
                    <!-- Dynamic tournaments -->
                </div>
            </div>
        </div>
    </div>

    <!-- Spectator Mode Notification -->
    <div class="spectator-notification cute" id="spectatorNotification" style="display: none;">
        <div class="notification-content cute">
            <i class="fas fa-eye"></i>
            <span>You are spectating this match. Click here to join the next available battle.</span>
            <button class="btn cute small" id="joinBattleBtn">
                <i class="fas fa-crosshairs"></i> Join Battle
            </button>
        </div>
    </div>
</div>

<script>
// Game state
const gameState = {
    currentRoom: null,
    opponent: null,
    battleActive: false,
    timeRemaining: 300,
    timerInterval: null,
    playerReady: false,
    opponentReady: false,
    codeSubmitted: false,
    matchResult: null,
    socket: null,
    username: localStorage.getItem('pp_username') || 'Player' + Math.floor(Math.random() * 1000),
    userId: localStorage.getItem('pp_userid') || 'user_' + Date.now(),
    rating: parseInt(localStorage.getItem('pp_rating')) || 1350,
    wins: parseInt(localStorage.getItem('pp_wins')) || 0,
    totalBattles: parseInt(localStorage.getItem('pp_total_battles')) || 0,
    soundsEnabled: true
};

// Mock server URL - replace with your actual server URL
const SERVER_URL = window.location.hostname === 'localhost' 
    ? 'http://localhost:3000' 
    : 'https://your-server-url.com';

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializePlayer();
    initializeSocket();
    setupEventListeners();
    loadPlayerStats();
    loadTournaments();
    initializeCodeEditor();
});

function initializePlayer() {
    // Set player name
    document.getElementById('playerName').textContent = gameState.username;
    document.getElementById('currentPlayerName').textContent = gameState.username;
    document.getElementById('resultPlayerName').textContent = gameState.username;
    
    // Set player initial
    const initial = gameState.username.charAt(0).toUpperCase();
    document.getElementById('playerAvatarInitial').textContent = initial;
    document.getElementById('playerInitial').textContent = initial;
    document.getElementById('resultPlayerInitial').textContent = initial;
    
    // Update player stats
    document.getElementById('playerRating').textContent = gameState.rating;
    document.getElementById('playerStats').textContent = `Wins: ${gameState.wins} • Rating: ${gameState.rating}`;
}

function initializeSocket() {
    // Create Socket.IO connection
    gameState.socket = io(SERVER_URL, {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000
    });

    // Socket event handlers
    gameState.socket.on('connect', () => {
        console.log('Connected to server');
        updateConnectionStatus(true);
        gameState.socket.emit('register_player', {
            username: gameState.username,
            userId: gameState.userId,
            rating: gameState.rating
        });
    });

    gameState.socket.on('disconnect', () => {
        console.log('Disconnected from server');
        updateConnectionStatus(false);
    });

    gameState.socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        showNotification('Connection error. Please refresh the page.', 'error');
    });

    gameState.socket.on('online_count', (count) => {
        document.getElementById('onlineCount').textContent = `${count} players online`;
    });

    gameState.socket.on('room_list', (rooms) => {
        updateRoomList(rooms);
    });

    gameState.socket.on('room_created', (data) => {
        handleRoomCreated(data);
    });

    gameState.socket.on('joined_room', (data) => {
        handleJoinedRoom(data);
    });

    gameState.socket.on('player_joined', (data) => {
        handlePlayerJoined(data);
    });

    gameState.socket.on('player_left', (data) => {
        handlePlayerLeft(data);
    });

    gameState.socket.on('player_ready', (data) => {
        handlePlayerReady(data);
    });

    gameState.socket.on('challenge_start', (data) => {
        startBattle(data);
    });

    gameState.socket.on('code_update', (data) => {
        handleCodeUpdate(data);
    });

    gameState.socket.on('challenge_result', (data) => {
        handleChallengeResult(data);
    });

    gameState.socket.on('match_complete', (data) => {
        handleMatchComplete(data);
    });

    gameState.socket.on('chat_message', (data) => {
        addChatMessage(data);
    });

    gameState.socket.on('matchmaking_update', (data) => {
        updateMatchmakingStatus(data);
    });

    gameState.socket.on('system_message', (data) => {
        addChatMessage({
            username: 'System',
            message: data.message,
            type: 'system'
        });
    });

    // Request initial room list
    setTimeout(() => {
        if (gameState.socket.connected) {
            gameState.socket.emit('get_rooms');
        }
    }, 1000);
}

function setupEventListeners() {
    // Room creation
    document.getElementById('createRoomBtn').addEventListener('click', showRoomCreation);
    document.getElementById('confirmCreateRoom').addEventListener('click', createRoom);
    document.getElementById('cancelCreateRoom').addEventListener('click', hideRoomCreation);
    
    // Quick match
    document.getElementById('quickMatchBtn').addEventListener('click', findQuickMatch);
    document.getElementById('cancelMatchmaking').addEventListener('click', cancelMatchmaking);
    
    // Room filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.dataset.filter;
            filterRooms(filter);
            updateFilterButtons(this);
        });
    });
    
    // Battle controls
    document.getElementById('readyBtn').addEventListener('click', toggleReady);
    document.getElementById('runMultiplayerBtn').addEventListener('click', runCode);
    document.getElementById('submitMultiplayerBtn').addEventListener('click', submitSolution);
    document.getElementById('requestHintBtn').addEventListener('click', requestHint);
    
    // Code editor buttons
    document.getElementById('formatCodeBtn').addEventListener('click', formatCode);
    document.getElementById('resetCodeBtn').addEventListener('click', resetCode);
    
    // Results actions
    document.getElementById('rematchBtn').addEventListener('click', requestRematch);
    document.getElementById('nextOpponentBtn').addEventListener('click', findNewOpponent);
    document.getElementById('backToLobbyBtn').addEventListener('click', returnToLobby);
    
    // Room management
    document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
    document.getElementById('inviteFriendBtn').addEventListener('click', inviteFriend);
    document.getElementById('copyRoomCode').addEventListener('click', copyRoomCode);
    
    // Chat
    document.getElementById('sendMessageBtn').addEventListener('click', sendChatMessage);
    document.getElementById('clearChatBtn').addEventListener('click', clearChat);
    document.getElementById('toggleSoundBtn').addEventListener('click', toggleSounds);
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
    
    // Spectator
    document.getElementById('joinBattleBtn').addEventListener('click', findQuickMatch);
    
    // Refresh rooms
    document.getElementById('refreshRooms').addEventListener('click', refreshRooms);
    
    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    // Code editor input
    const codeEditor = document.getElementById('multiplayerCode');
    let typingTimeout;
    codeEditor.addEventListener('input', function() {
        updateCodeStats();
        
        // Debounce sending code updates
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            sendCodeUpdate();
        }, 500);
    });
}

function initializeCodeEditor() {
    // Initialize CodeMirror for better code editing experience
    const textarea = document.getElementById('multiplayerCode');
    const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: 'default',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        electricChars: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        extraKeys: {
            "Tab": function(cm) {
                cm.replaceSelection("    ", "end");
            }
        }
    });
    
    // Store editor reference
    gameState.codeEditor = editor;
    
    // Update stats on editor change
    editor.on('change', function() {
        updateCodeStats();
    });
}

function updateCodeStats() {
    if (!gameState.codeEditor) return;
    
    const code = gameState.codeEditor.getValue();
    const lines = code.split('\n').length;
    const chars = code.length;
    
    document.getElementById('playerCodeLines').textContent = `${lines} lines`;
    document.getElementById('playerActivity').textContent = lines > 1 ? 'Coding...' : 'Idle';
    
    // Send code update to opponent
    if (gameState.battleActive && !gameState.codeSubmitted) {
        gameState.socket.emit('code_update', {
            roomId: gameState.currentRoom,
            lines: lines,
            chars: chars,
            username: gameState.username
        });
    }
}

function formatCode() {
    if (!gameState.codeEditor) return;
    
    const code = gameState.codeEditor.getValue();
    // Simple formatting - indent Python code
    const lines = code.split('\n');
    let indent = 0;
    const formatted = lines.map(line => {
        line = line.trim();
        
        // Decrease indent for dedent keywords
        if (line.startsWith('return') || line.startsWith('pass') || line.startsWith('break') || 
            line.startsWith('continue') || line.startsWith('raise')) {
            indent = Math.max(0, indent - 1);
        }
        
        const indentedLine = '    '.repeat(indent) + line;
        
        // Increase indent for block starters
        if (line.endsWith(':') && !line.startsWith('#') && !line.includes('#')) {
            indent++;
        }
        
        return indentedLine;
    }).join('\n');
    
    gameState.codeEditor.setValue(formatted);
    showNotification('Code formatted!', 'success');
}

function resetCode() {
    if (!gameState.codeEditor) return;
    
    const starterCode = `# Multiplayer Challenge
# Write your solution below

def solve_challenge():
    # Your code here
    return "Hello, World!"`;
    
    gameState.codeEditor.setValue(starterCode);
    showNotification('Code reset!', 'info');
}

function showRoomCreation() {
    const form = document.getElementById('roomCreationForm');
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth' });
}

function hideRoomCreation() {
    document.getElementById('roomCreationForm').style.display = 'none';
}

function createRoom() {
    const roomName = document.getElementById('roomName').value || `${gameState.username}'s Room`;
    const challengeId = document.getElementById('challengeSelect').value;
    const timeLimit = document.getElementById('timeLimit').value;
    const isPrivate = document.getElementById('privateRoom').checked;
    
    if (!roomName.trim()) {
        showNotification('Please enter a room name', 'error');
        return;
    }
    
    gameState.socket.emit('create_room', {
        name: roomName,
        challengeId: challengeId,
        timeLimit: parseInt(timeLimit),
        isPrivate: isPrivate,
        username: gameState.username,
        userId: gameState.userId,
        rating: gameState.rating
    });
    
    hideRoomCreation();
    showNotification('Creating room...', 'info');
}

function handleRoomCreated(data) {
    gameState.currentRoom = data.roomId;
    showWaitingLobby();
    document.getElementById('roomCodeDisplay').textContent = data.roomCode || data.roomId.substring(0, 8).toUpperCase();
    
    addChatMessage({
        username: 'System',
        message: `Room "${data.roomName}" created successfully!`,
        type: 'system'
    });
}

function findQuickMatch() {
    const quickMatchBtn = document.getElementById('quickMatchBtn');
    const matchmakingStatus = document.getElementById('matchmakingStatus');
    
    quickMatchBtn.style.display = 'none';
    matchmakingStatus.style.display = 'block';
    
    gameState.socket.emit('find_quick_match', {
        username: gameState.username,
        userId: gameState.userId,
        rating: gameState.rating,
        preferredDifficulty: 'any'
    });
    
    showNotification('Searching for opponent...', 'info');
}

function cancelMatchmaking() {
    const quickMatchBtn = document.getElementById('quickMatchBtn');
    const matchmakingStatus = document.getElementById('matchmakingStatus');
    
    quickMatchBtn.style.display = 'block';
    matchmakingStatus.style.display = 'none';
    
    gameState.socket.emit('cancel_matchmaking');
    showNotification('Matchmaking cancelled', 'warning');
}

function updateMatchmakingStatus(data) {
    const statusText = document.querySelector('.searching-animation span');
    if (statusText && data.message) {
        statusText.textContent = data.message;
    }
    
    if (data.found) {
        showNotification('Opponent found! Joining room...', 'success');
    }
}

function joinRoom(roomId) {
    gameState.socket.emit('join_room', {
        roomId: roomId,
        username: gameState.username,
        userId: gameState.userId,
        rating: gameState.rating
    });
}

function filterRooms(filter) {
    const rooms = document.querySelectorAll('.room-item');
    rooms.forEach(room => {
        if (filter === 'all' || room.dataset.difficulty === filter || 
            (filter === 'empty' && room.dataset.players === '1')) {
            room.style.display = 'flex';
        } else {
            room.style.display = 'none';
        }
    });
}

function updateFilterButtons(activeButton) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    activeButton.classList.add('active');
}

function handleJoinedRoom(data) {
    gameState.currentRoom = data.roomId;
    gameState.opponent = data.opponent;
    
    showWaitingLobby();
    document.getElementById('roomCodeDisplay').textContent = data.roomCode || data.roomId.substring(0, 8).toUpperCase();
    
    // Update opponent info if already present
    if (data.opponent) {
        updateOpponentInfo(data.opponent);
    }
    
    addChatMessage({
        username: 'System',
        message: `Joined room: ${data.roomName || data.roomId}`,
        type: 'system'
    });
}

function handlePlayerJoined(data) {
    gameState.opponent = data.username;
    updateOpponentInfo(data.username);
    
    if (data.rating) {
        document.getElementById('opponentRating').textContent = data.rating;
        document.getElementById('opponentStats').textContent = `Wins: ${data.wins || '???'} • Rating: ${data.rating}`;
    }
    
    addChatMessage({
        username: 'System',
        message: `${data.username} joined the room`,
        type: 'system'
    });
    
    playSound('join');
}

function handlePlayerLeft(data) {
    if (data.username === gameState.opponent) {
        gameState.opponent = null;
        gameState.opponentReady = false;
        updateOpponentInfo('Waiting for opponent...');
        
        addChatMessage({
            username: 'System',
            message: `${data.username} left the room`,
            type: 'system'
        });
        
        // If battle was active, end it
        if (gameState.battleActive) {
            endBattleEarly();
        }
    }
}

function toggleReady() {
    const readyBtn = document.getElementById('readyBtn');
    gameState.playerReady = !gameState.playerReady;
    
    if (gameState.playerReady) {
        readyBtn.innerHTML = '<i class="fas fa-times"></i> Not Ready';
        readyBtn.classList.add('ready');
    } else {
        readyBtn.innerHTML = '<i class="fas fa-check"></i> Ready';
        readyBtn.classList.remove('ready');
    }
    
    gameState.socket.emit('player_ready', {
        roomId: gameState.currentRoom,
        isReady: gameState.playerReady,
        username: gameState.username,
        userId: gameState.userId
    });
}

function handlePlayerReady(data) {
    if (data.userId === gameState.userId) {
        gameState.playerReady = data.isReady;
    } else {
        gameState.opponentReady = data.isReady;
        updateOpponentReady(data.isReady);
        
        if (data.isReady) {
            addChatMessage({
                username: 'System',
                message: `${data.username} is ready!`,
                type: 'system'
            });
        }
    }
    
    // Check if both players are ready
    if (gameState.playerReady && gameState.opponentReady && gameState.currentRoom) {
        gameState.socket.emit('start_battle', { 
            roomId: gameState.currentRoom 
        });
    }
}

function startBattle(data) {
    gameState.battleActive = true;
    gameState.timeRemaining = data.timeLimit || 300;
    gameState.playerReady = false;
    gameState.opponentReady = false;
    gameState.codeSubmitted = false;
    
    // Switch to battle interface
    document.getElementById('waitingLobby').style.display = 'none';
    document.getElementById('battleInterface').style.display = 'block';
    
    // Update battle info
    document.getElementById('battleChallenge').textContent = data.challenge.title;
    document.getElementById('challengeDifficulty').textContent = data.challenge.difficulty;
    document.getElementById('challengePoints').textContent = `${data.challenge.points} points`;
    
    // Load challenge description
    if (data.challenge.description) {
        const output = document.getElementById('playerOutput');
        output.textContent = `Challenge: ${data.challenge.title}\n\n${data.challenge.description}\n\nRequirements:\n${data.challenge.requirements || 'Complete the challenge correctly'}`;
    }
    
    // Load starter code if provided
    if (data.challenge.starter_code && gameState.codeEditor) {
        gameState.codeEditor.setValue(data.challenge.starter_code);
    }
    
    // Start timer
    startTimer();
    
    // Reset controls
    document.getElementById('submitMultiplayerBtn').disabled = false;
    
    addChatMessage({
        username: 'System',
        message: `Battle started: ${data.challenge.title}`,
        type: 'system'
    });
    
    playSound('battle_start');
}

function startTimer() {
    clearInterval(gameState.timerInterval);
    updateTimer();
    
    gameState.timerInterval = setInterval(() => {
        if (gameState.timeRemaining > 0) {
            gameState.timeRemaining--;
            updateTimer();
            
            // Warning sounds
            if (gameState.timeRemaining === 60) {
                playSound('warning');
            } else if (gameState.timeRemaining === 30) {
                playSound('warning');
            } else if (gameState.timeRemaining <= 10 && gameState.timeRemaining > 0) {
                playSound('tick');
            }
            
            // Auto-submit if time runs out
            if (gameState.timeRemaining === 0 && !gameState.codeSubmitted) {
                submitSolution();
            }
        } else {
            clearInterval(gameState.timerInterval);
        }
    }, 1000);
}

function updateTimer() {
    const minutes = Math.floor(gameState.timeRemaining / 60);
    const seconds = gameState.timeRemaining % 60;
    const timerDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    document.getElementById('timerDisplay').textContent = timerDisplay;
    document.getElementById('timeRemaining').textContent = timerDisplay;
    
    // Color code based on time remaining
    const timerElement = document.getElementById('battleTimer');
    timerElement.classList.remove('warning', 'critical');
    
    if (gameState.timeRemaining <= 60) {
        timerElement.classList.add('warning');
    }
    if (gameState.timeRemaining <= 30) {
        timerElement.classList.add('critical');
    }
}

function runCode() {
    if (!gameState.codeEditor) return;
    
    const code = gameState.codeEditor.getValue();
    const output = document.getElementById('playerOutput');
    
    try {
        // Create a safe execution environment
        const result = executePythonCode(code);
        output.textContent = result;
        output.className = 'success';
        showNotification('Code executed successfully!', 'success');
        
        // Update opponent status
        gameState.socket.emit('code_update', {
            roomId: gameState.currentRoom,
            type: 'run',
            username: gameState.username
        });
        
    } catch (error) {
        output.textContent = `Error: ${error.message}`;
        output.className = 'error';
        showNotification('Code execution failed', 'error');
    }
}

function executePythonCode(code) {
    // This is a mock execution - in a real app, you would send to a backend
    // For now, we'll simulate execution
    
    // Check for basic Python syntax
    if (!code.includes('def ') && !code.includes('return')) {
        return "No function defined. Please define a function named 'solve_challenge()'.";
    }
    
    // Simulate test cases
    const testCases = [
        { input: '', expected: "Hello, World!" },
        { input: 'test', expected: "Hello, World!" }
    ];
    
    let results = "Test Results:\n";
    let passed = 0;
    
    testCases.forEach((test, i) => {
        results += `\nTest ${i + 1}: `;
        // Simple mock - in reality, you'd need a Python interpreter
        if (code.includes('return "Hello, World!"')) {
            results += "✓ PASSED";
            passed++;
        } else {
            results += "✗ FAILED";
        }
    });
    
    results += `\n\n${passed}/${testCases.length} tests passed`;
    
    return results;
}

function submitSolution() {
    if (!gameState.battleActive) {
        showNotification('No active battle', 'error');
        return;
    }
    
    if (!gameState.codeEditor) return;
    
    const code = gameState.codeEditor.getValue();
    gameState.codeSubmitted = true;
    
    // Calculate score based on time remaining and code quality
    const timeBonus = Math.floor(gameState.timeRemaining / 10);
    const codeLength = code.length;
    const lengthPenalty = Math.max(0, Math.floor((codeLength - 100) / 50));
    const score = 100 + timeBonus - lengthPenalty;
    
    const resultData = {
        roomId: gameState.currentRoom,
        code: code,
        username: gameState.username,
        userId: gameState.userId,
        score: Math.max(10, score),
        timeUsed: gameState.timeRemaining,
        lines: code.split('\n').length,
        runs: 1 // This would be tracked
    };
    
    gameState.socket.emit('submit_solution', resultData);
    
    // Update UI
    document.getElementById('playerScore').textContent = resultData.score;
    document.getElementById('submitMultiplayerBtn').disabled = true;
    
    showNotification('Solution submitted!', 'success');
    playSound('submit');
}

function requestHint() {
    if (gameState.timeRemaining > 10) {
        gameState.timeRemaining -= 10;
        updateTimer();
        showNotification('Hint: Check the function return statement', 'info');
        playSound('hint');
    } else {
        showNotification('Not enough time for hint', 'warning');
    }
}

function handleCodeUpdate(data) {
    if (data.userId !== gameState.userId) {
        // Update opponent activity indicators
        document.getElementById('opponentActivity').textContent = 'Typing...';
        document.getElementById('opponentCodeLength').textContent = data.chars || 0;
        document.getElementById('opponentProgress').textContent = `${Math.min(Math.round((data.chars || 0) / 500 * 100), 100)}% complete`;
        
        // Update progress bar
        const progress = Math.min((data.chars || 0) / 500 * 100, 100);
        document.getElementById('opponentActivityBar').style.width = `${progress}%`;
        
        // Show/hide indicators
        const typingIndicator = document.querySelector('.indicator.typing');
        const testingIndicator = document.querySelector('.indicator.testing');
        
        if (data.type === 'run') {
            if (typingIndicator) typingIndicator.style.display = 'none';
            if (testingIndicator) testingIndicator.style.display = 'block';
            document.getElementById('opponentLastAction').textContent = 'Testing code...';
        } else {
            if (typingIndicator) typingIndicator.style.display = 'block';
            if (testingIndicator) testingIndicator.style.display = 'none';
            document.getElementById('opponentLastAction').textContent = 'Writing code...';
        }
        
        // Update run count
        if (data.type === 'run') {
            const current = parseInt(document.getElementById('opponentRunCount').textContent) || 0;
            document.getElementById('opponentRunCount').textContent = current + 1;
            document.getElementById('opponentLastTest').textContent = 'Just now';
        }
    }
}

function handleChallengeResult(data) {
    if (data.userId === gameState.userId) {
        // Player's result
        updatePlayerResult(data);
    } else {
        // Opponent's result
        updateOpponentResult(data);
    }
    
    // Store result for comparison
    if (!gameState.matchResult) gameState.matchResult = {};
    gameState.matchResult[data.userId] = data;
    
    // Check if both results are in
    if (gameState.matchResult[gameState.userId] && gameState.opponent && gameState.matchResult[gameState.opponent]) {
        determineWinner();
    }
}

function determineWinner() {
    const playerResult = gameState.matchResult[gameState.userId];
    const opponentResult = gameState.matchResult[gameState.opponent];

    let winner = null;
    if (playerResult.score > opponentResult.score) {
        winner = gameState.username;
    } else if (opponentResult.score > playerResult.score) {
        winner = gameState.opponent;
    }

    gameState.socket.emit('match_result', {
        roomId: gameState.currentRoom,
        winner: winner,
        player1: gameState.username,
        player2: gameState.opponent,
        player1Score: playerResult.score,
        player2Score: opponentResult.score
    });
}

function handleMatchComplete(data) {
    stopTimer();
    
    // Update results screen
    showResults(data);
    
    // Update player stats
    updatePlayerStats(data);
    
    // Reset game state
    gameState.battleActive = false;
    gameState.matchResult = null;
    
    // Show results after delay
    setTimeout(() => {
        document.getElementById('battleInterface').style.display = 'none';
        document.getElementById('resultsScreen').style.display = 'block';
    }, 2000);
    
    playSound(data.winner === gameState.username ? 'victory' : 'defeat');
}

function showResults(data) {
    const resultScreen = document.getElementById('resultsScreen');
    const resultTitle = document.getElementById('resultTitle');
    
    if (data.winner === gameState.username) {
        resultTitle.textContent = 'Victory! 🎉';
        resultScreen.classList.add('victory');
        resultScreen.classList.remove('defeat', 'draw');
    } else if (data.winner === gameState.opponent) {
        resultTitle.textContent = 'Defeat 💥';
        resultScreen.classList.add('defeat');
        resultScreen.classList.remove('victory', 'draw');
    } else {
        resultTitle.textContent = 'Draw 🤝';
        resultScreen.classList.add('draw');
        resultScreen.classList.remove('victory', 'defeat');
    }
    
    // Update scores
    document.getElementById('finalPlayerScore').textContent = data.player1Score;
    document.getElementById('finalOpponentScore').textContent = data.player2Score;
    document.getElementById('finalOpponentName').textContent = gameState.opponent || 'Opponent';
    
    // Update rating change
    const ratingChange = document.getElementById('ratingChange');
    if (data.winner === gameState.username) {
        ratingChange.textContent = `+${data.ratingChange || 25}`;
        ratingChange.className = 'change-value positive';
    } else if (data.winner === gameState.opponent) {
        ratingChange.textContent = `-${data.ratingChange || 15}`;
        ratingChange.className = 'change-value negative';
    } else {
        ratingChange.textContent = '±0';
        ratingChange.className = 'change-value neutral';
    }
    
    // Update rewards
    updateRewardsList(data);
    
    // Update performance metrics
    updatePerformanceMetrics(data);
}

function updateRewardsList(data) {
    const rewardsList = document.getElementById('rewardsList');
    rewardsList.innerHTML = '';
    
    const rewards = [
        { icon: 'fa-coins', text: `+${data.xp || 100} XP` },
        { icon: 'fa-trophy', text: data.winner === gameState.username ? 'Victory Bonus' : 'Participation' },
        { icon: 'fa-star', text: `Win Streak: ${data.winStreak || 1}` }
    ];
    
    rewards.forEach(reward => {
        const item = document.createElement('div');
        item.className = 'reward-item cute';
        item.innerHTML = `
            <i class="fas ${reward.icon}"></i>
            <span>${reward.text}</span>
        `;
        rewardsList.appendChild(item);
    });
}

function updatePerformanceMetrics(data) {
    const metricsContainer = document.getElementById('performanceMetrics');
    metricsContainer.innerHTML = '';
    
    const metrics = [
        { label: 'Code Quality', value: data.codeQuality || 85 },
        { label: 'Speed', value: data.speed || 95 },
        { label: 'Efficiency', value: data.efficiency || 78 }
    ];
    
    metrics.forEach(metric => {
        const metricDiv = document.createElement('div');
        metricDiv.className = 'metric cute';
        metricDiv.innerHTML = `
            <span class="metric-label">${metric.label}</span>
            <div class="metric-bar">
                <div class="metric-fill" style="width: ${metric.value}%"></div>
            </div>
            <span class="metric-value">${metric.value}%</span>
        `;
        metricsContainer.appendChild(metricDiv);
    });
}

function updatePlayerStats(data) {
    // Update local storage
    gameState.totalBattles++;
    
    if (data.winner === gameState.username) {
        gameState.wins++;
        gameState.rating += data.ratingChange || 25;
    } else if (data.winner === gameState.opponent) {
        gameState.rating = Math.max(0, gameState.rating - (data.ratingChange || 15));
    }
    
    localStorage.setItem('pp_wins', gameState.wins);
    localStorage.setItem('pp_rating', gameState.rating);
    localStorage.setItem('pp_total_battles', gameState.totalBattles);
    
    // Update UI
    document.getElementById('totalBattles').textContent = gameState.totalBattles;
    const winRate = gameState.totalBattles > 0 ? Math.round((gameState.wins / gameState.totalBattles) * 100) : 0;
    document.getElementById('winRate').textContent = `${winRate}%`;
    
    // Update player info
    document.getElementById('playerRating').textContent = gameState.rating;
    document.getElementById('playerStats').textContent = `Wins: ${gameState.wins} • Rating: ${gameState.rating}`;
}

function updateRoomList(rooms) {
    const container = document.getElementById('roomsContainer');
    container.innerHTML = '';
    
    if (!rooms || rooms.length === 0) {
        container.innerHTML = '<div class="no-rooms">No active rooms. Create one!</div>';
        return;
    }
    
    rooms.forEach(room => {
        const roomElement = createRoomElement(room);
        container.appendChild(roomElement);
    });
}

function createRoomElement(room) {
    const div = document.createElement('div');
    div.className = 'room-item cute';
    div.dataset.difficulty = room.difficulty || 'beginner';
    div.dataset.players = room.players?.length || 1;
    
    const playerCount = room.players?.length || 1;
    const maxPlayers = 2;
    const status = playerCount >= maxPlayers ? 'full' : 
                  room.status === 'playing' ? 'playing' : 'waiting';
    
    div.innerHTML = `
        <div class="room-info">
            <div class="room-header">
                <h4>${room.name || 'Unnamed Room'}</h4>
                <span class="room-status ${status}">
                    ${status === 'waiting' ? 'Waiting...' : 
                      status === 'full' ? 'Full' : 
                      status === 'playing' ? 'In Progress' : status}
                </span>
            </div>
            <div class="room-details">
                <span class="detail">
                    <i class="fas fa-user"></i>
                    ${playerCount}/${maxPlayers} players
                </span>
                <span class="detail">
                    <i class="fas fa-trophy"></i>
                    ${room.difficulty || 'Beginner'}
                </span>
                <span class="detail">
                    <i class="fas fa-clock"></i>
                    ${Math.floor(room.timeLimit / 60)}:${(room.timeLimit % 60).toString().padStart(2, '0')}
                </span>
            </div>
            <div class="room-creator">
                <i class="fas fa-crown"></i>
                Creator: ${room.creator || 'Unknown'}
            </div>
        </div>
        <button class="btn cute small join-btn" data-room-id="${room.id}" 
                ${status === 'full' ? 'disabled' : ''}>
            ${status === 'waiting' ? 'Join' : 
              status === 'playing' ? 'Spectate' : 'Full'}
        </button>
    `;
    
    const joinBtn = div.querySelector('.join-btn');
    if (!joinBtn.disabled) {
        joinBtn.addEventListener('click', function() {
            joinRoom(this.dataset.roomId);
        });
    }
    
    return div;
}

function updateOpponentInfo(username) {
    const opponentNameDisplay = document.getElementById('opponentNameDisplay');
    const opponentName = document.getElementById('opponentName');
    
    if (opponentNameDisplay) opponentNameDisplay.textContent = username || 'Waiting for opponent...';
    if (opponentName) opponentName.textContent = username || 'Opponent';
    
    // Update placeholder avatar
    const avatar = document.querySelector('.opponent .player-avatar i');
    if (avatar && username) {
        avatar.className = 'fas fa-user';
    }
}

function updateOpponentReady(isReady) {
    const statusText = document.getElementById('opponentStatusText');
    const statusIndicator = document.getElementById('opponentStatusIndicator');
    
    if (statusText) {
        statusText.textContent = isReady ? 'Ready' : 'Not Ready';
    }
    
    if (statusIndicator) {
        if (isReady) {
            statusIndicator.innerHTML = '<i class="fas fa-check-circle"></i><span>Ready</span>';
            statusIndicator.className = 'status ready';
        } else {
            statusIndicator.innerHTML = '<i class="fas fa-clock"></i><span>Not Ready</span>';
            statusIndicator.className = 'status not-ready';
        }
    }
}

function updateConnectionStatus(connected) {
    const statusIndicator = document.getElementById('statusIndicator');
    if (statusIndicator) {
        statusIndicator.className = `status-indicator ${connected ? 'connected' : 'disconnected'}`;
        document.getElementById('connectionStatus').textContent = connected ? 
            'Connected to Battle Server' : 'Disconnected - Reconnecting...';
    }
}

function refreshRooms() {
    if (gameState.socket.connected) {
        gameState.socket.emit('get_rooms');
        showNotification('Refreshing room list...', 'info');
    } else {
        showNotification('Not connected to server', 'error');
    }
}

function showWaitingLobby() {
    document.getElementById('waitingLobby').style.display = 'flex';
    document.getElementById('battleInterface').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'none';
}

function leaveRoom() {
    if (gameState.currentRoom) {
        gameState.socket.emit('leave_room', {
            roomId: gameState.currentRoom,
            username: gameState.username,
            userId: gameState.userId
        });
        
        resetGameState();
        showNotification('Left the room', 'info');
    }
}

function inviteFriend() {
    const roomCode = document.getElementById('roomCodeDisplay').textContent;
    const inviteText = `Join my Python Pathfinder battle! Room Code: ${roomCode}\nServer: ${SERVER_URL}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Python Pathfinder Battle',
            text: inviteText,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(inviteText);
        showNotification('Invite link copied to clipboard!', 'success');
    }
}

function copyRoomCode() {
    const roomCode = document.getElementById('roomCodeDisplay').textContent;
    navigator.clipboard.writeText(roomCode);
    showNotification('Room code copied!', 'success');
    playSound('copy');
}

function requestRematch() {
    if (gameState.currentRoom) {
        gameState.socket.emit('request_rematch', {
            roomId: gameState.currentRoom,
            username: gameState.username,
            userId: gameState.userId
        });
        showNotification('Rematch request sent', 'info');
    }
}

function findNewOpponent() {
    if (gameState.currentRoom) {
        gameState.socket.emit('leave_room', {
            roomId: gameState.currentRoom,
            username: gameState.username,
            userId: gameState.userId
        });
    }
    
    resetGameState();
    findQuickMatch();
}

function returnToLobby() {
    if (gameState.currentRoom) {
        gameState.socket.emit('leave_room', {
            roomId: gameState.currentRoom,
            username: gameState.username,
            userId: gameState.userId
        });
    }
    
    resetGameState();
    showNotification('Returned to lobby', 'info');
}

function endBattleEarly() {
    stopTimer();
    gameState.battleActive = false;
    
    showNotification('Opponent disconnected. Battle ended.', 'warning');
    
    // Return to waiting lobby
    document.getElementById('battleInterface').style.display = 'none';
    document.getElementById('waitingLobby').style.display = 'flex';
}

function stopTimer() {
    clearInterval(gameState.timerInterval);
}

function resetGameState() {
    gameState.currentRoom = null;
    gameState.opponent = null;
    gameState.battleActive = false;
    gameState.timeRemaining = 300;
    gameState.timerInterval = null;
    gameState.playerReady = false;
    gameState.opponentReady = false;
    gameState.codeSubmitted = false;
    gameState.matchResult = null;
    
    // Reset UI
    document.getElementById('waitingLobby').style.display = 'none';
    document.getElementById('battleInterface').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'none';
    
    // Reset opponent info
    updateOpponentInfo(null);
    updateOpponentReady(false);
    document.getElementById('opponentRating').textContent = '---';
    document.getElementById('opponentStats').textContent = 'Wins: --- • Rating: ---';
    
    // Reset progress indicators
    document.getElementById('opponentActivityBar').style.width = '0%';
    document.getElementById('opponentProgress').textContent = '0% complete';
    document.querySelectorAll('.indicator').forEach(ind => {
        ind.style.display = 'none';
    });
    
    // Reset chat
    clearChat();
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message && gameState.currentRoom) {
        gameState.socket.emit('chat_message', {
            roomId: gameState.currentRoom,
            message: message,
            username: gameState.username,
            userId: gameState.userId,
            type: 'player'
        });
        
        input.value = '';
    }
}

function addChatMessage(data) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    messageDiv.className = `message ${data.type || 'player'}`;
    
    if (data.type === 'system') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <span class="message-text">${data.message}</span>
                <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
        `;
    } else {
        const isOwnMessage = data.userId === gameState.userId;
        messageDiv.className = `message ${isOwnMessage ? 'player' : 'opponent'}`;
        messageDiv.innerHTML = `
            <div class="message-sender">${data.username}</div>
            <div class="message-content">
                <span class="message-text">${data.message}</span>
                <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Play sound for new messages (not own messages)
    if (data.userId !== gameState.userId && gameState.soundsEnabled) {
        playSound('message');
    }
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    // Add welcome message
    addChatMessage({
        username: 'System',
        message: 'Welcome to the battle arena!',
        type: 'system'
    });
}

function toggleSounds() {
    gameState.soundsEnabled = !gameState.soundsEnabled;
    const icon = document.querySelector('#toggleSoundBtn i');
    icon.className = gameState.soundsEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
    showNotification(gameState.soundsEnabled ? 'Sounds enabled' : 'Sounds disabled', 'info');
}

function playSound(type) {
    if (!gameState.soundsEnabled) return;
    
    const sounds = {
        join: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3'),
        leave: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-retro-game-emergency-alarm-1000.mp3'),
        battle_start: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-game-show-intro-331.mp3'),
        submit: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
        victory: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
        defeat: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-game-over-470.mp3'),
        warning: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-1551.mp3'),
        tick: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-fast-clock-ticking-1050.mp3'),
        hint: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkles-success-275.mp3'),
        message: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3'),
        copy: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3')
    };
    
    if (sounds[type]) {
        sounds[type].volume = 0.3;
        sounds[type].play().catch(e => console.log('Audio play failed:', e));
    }
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `multiplayer-notification ${type} cute`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        background: white;
        border: 2px solid ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : type === 'warning' ? '#FF9800' : 'var(--cute-primary)'};
        color: #333;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function loadPlayerStats() {
    // Update stats from localStorage
    document.getElementById('totalBattles').textContent = gameState.totalBattles;
    const winRate = gameState.totalBattles > 0 ? Math.round((gameState.wins / gameState.totalBattles) * 100) : 0;
    document.getElementById('winRate').textContent = `${winRate}%`;
    document.getElementById('totalLines').textContent = localStorage.getItem('pp_total_lines') || '0';
}

function loadTournaments() {
    const tournamentList = document.getElementById('tournamentList');
    
    // Mock tournament data
    const tournaments = [
        {
            name: 'Weekly Python Cup',
            status: 'active',
            players: '32/64',
            time: '2h remaining',
            buttonText: 'Join',
            buttonIcon: 'fa-play'
        },
        {
            name: 'Beginner Battle Royale',
            status: 'upcoming',
            players: '0/16',
            time: 'Starts in 30m',
            buttonText: 'Notify',
            buttonIcon: 'fa-bell'
        }
    ];
    
    tournamentList.innerHTML = '';
    
    tournaments.forEach(tournament => {
        const item = document.createElement('div');
        item.className = 'tournament-item cute';
        item.innerHTML = `
            <div class="tournament-header">
                <h4>${tournament.name}</h4>
                <span class="tournament-status ${tournament.status}">${tournament.status === 'active' ? 'Live' : 'Soon'}</span>
            </div>
            <div class="tournament-details">
                <span class="detail">
                    <i class="fas fa-users"></i>
                    ${tournament.players} players
                </span>
                <span class="detail">
                    <i class="fas fa-clock"></i>
                    ${tournament.time}
                </span>
            </div>
            <button class="btn cute small">
                <i class="fas ${tournament.buttonIcon}"></i> ${tournament.buttonText}
            </button>
        `;
        tournamentList.appendChild(item);
    });
}

function toggleTheme() {
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    
    if (body.classList.contains('cute-theme')) {
        body.classList.remove('cute-theme');
        body.classList.add('deadly-theme');
        themeToggle.textContent = 'Switch to Cute Mode';
        document.querySelectorAll('.cute').forEach(el => {
            el.classList.remove('cute');
            el.classList.add('deadly');
        });
    } else {
        body.classList.remove('deadly-theme');
        body.classList.add('cute-theme');
        themeToggle.textContent = 'Switch to Deadly Mode';
        document.querySelectorAll('.deadly').forEach(el => {
            el.classList.remove('deadly');
            el.classList.add('cute');
        });
    }
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

@keyframes float {
    0%, 100% { transform: rotate(45deg) translateY(0); }
    50% { transform: rotate(45deg) translateY(-20px); }
}

@keyframes scan {
    0% { top: 0; }
    100% { top: 100%; }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.floating-heart:before,
.floating-heart:after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: inherit;
    border-radius: 50%;
}

.floating-heart:before {
    top: -50%;
    left: 0;
}

.floating-heart:after {
    top: 0;
    left: -50%;
}

.pulse-dot {
    width: 10px;
    height: 10px;
    background: var(--cute-primary);
    border-radius: 50%;
    margin-right: 10px;
    animation: pulse 1.5s infinite;
}

.room-status.waiting {
    color: #FF9800;
    background: rgba(255, 152, 0, 0.1);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
}

.room-status.full {
    color: #F44336;
    background: rgba(244, 67, 54, 0.1);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
}

.room-status.playing {
    color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
}

.player-status.ready {
    color: #4CAF50;
}

.player-status.waiting {
    color: #FF9800;
}

.battle-timer.warning {
    color: #FF9800;
    animation: pulse 1s infinite;
}

.battle-timer.critical {
    color: #F44336;
    animation: pulse 0.5s infinite;
}

.status.ready {
    color: #4CAF50;
}

.status.not-ready {
    color: #FF9800;
}

.change-value.positive {
    color: #4CAF50;
}

.change-value.negative {
    color: #F44336;
}

.change-value.neutral {
    color: #9E9E9E;
}

.results-screen.victory .result-icon {
    color: #FFD700;
}

.results-screen.defeat .result-icon {
    color: #F44336;
}

.results-screen.draw .result-icon {
    color: #9E9E9E;
}

.code-hidden {
    filter: blur(5px);
    user-select: none;
    color: transparent;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.indicator-bar {
    height: 4px;
    background: var(--cute-primary);
    border-radius: 2px;
    animation: pulse 2s infinite;
    width: 100%;
}

.no-rooms {
    text-align: center;
    padding: 2rem;
    color: #666;
    font-style: italic;
}

/* CodeMirror overrides */
.CodeMirror {
    height: 200px;
    border: 2px solid var(--cute-secondary);
    border-top: none;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.CodeMirror-focused {
    border-color: var(--cute-primary);
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .multiplayer-content {
        grid-template-columns: 250px 1fr;
    }
    
    .battle-sidebar {
        display: none;
    }
}

@media (max-width: 900px) {
    .multiplayer-content {
        grid-template-columns: 1fr;
    }
    
    .room-browser {
        display: none;
    }
    
    .battle-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
    }
    
    .vs-divider {
        flex-direction: row;
        padding: 1rem;
    }
    
    .result-details {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 600px) {
    .multiplayer-container {
        padding: 1rem;
    }
    
    .multiplayer-header h1 {
        font-size: 1.8rem;
    }
    
    .connection-status {
        flex-direction: column;
        gap: 1rem;
    }
    
    .battle-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .player-list {
        flex-direction: column;
        align-items: center;
    }
    
    .result-comparison {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        gap: 1rem;
    }
    
    .result-actions {
        flex-direction: column;
    }
    
    .CodeMirror {
        height: 150px;
    }
}
`;
document.head.appendChild(style);
</script>
</main>
</body>
</html>
